#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 202601061012-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.pro
# @License       : WTFPL
# @ReadME        : ranger_scope --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Tuesday, Mar 16, 2021 05:58 EDT
# @File          : ranger_scope
# @Description   : File preview script for ranger
# @Changelog     : Refactored for self-contained operation
# @TODO          :
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Script variables
PROG="ranger_scope"
VERSION="202601061012-git"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Environment Detection
__get_os() {
  case "$(uname -s)" in
    Linux*) echo "linux" ;;
    Darwin*) echo "mac" ;;
    *BSD*) echo "bsd" ;;
    MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
    *) echo "unknown" ;;
  esac
}

__is_remote() {
  [ -n "${SSH_CLIENT:-}" ] || [ -n "${SSH_TTY:-}" ] || [ -n "${SSH_CONNECTION:-}" ]
}

__has_display() {
  [ -n "${DISPLAY:-}" ] || [ -n "${WAYLAND_DISPLAY:-}" ]
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Core helper functions
__cmd_exists() { command -v "$1" >/dev/null 2>&1; }

__is_running() {
  local proc="$1"
  case "$(__get_os)" in
    mac) pgrep -x "$proc" >/dev/null 2>&1 ;;
    windows) tasklist 2>/dev/null | grep -qi "$proc" ;;
    *) pgrep -x "$proc" >/dev/null 2>&1 || pgrep -f "$proc" >/dev/null 2>&1 ;;
  esac
}

__printf_color() {
  local color="${2:-0}"
  printf "\033[0;%sm%s\033[0m\n" "$color" "$1"
}
__printf_red() { __printf_color "$1" "31"; }
__printf_green() { __printf_color "$1" "32"; }
__printf_yellow() { __printf_color "$1" "33"; }
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Smart notifications
__notifications() {
  local title="$1" msg="$2"

  # Remote/no display - just print to stderr
  if __is_remote || ! __has_display; then
    printf "[%s] %s\n" "$title" "$msg" >&2
    return 0
  fi

  # GUI notifications based on OS
  case "$(__get_os)" in
    mac)
      osascript -e "display notification \"$msg\" with title \"$title\"" 2>/dev/null && return 0
      ;;
    linux|bsd)
      if __cmd_exists notify-send; then
        notify-send "$title" "$msg" 2>/dev/null && return 0
      fi
      ;;
    windows)
      if __cmd_exists powershell.exe; then
        powershell.exe -Command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show('$msg', '$title')" 2>/dev/null && return 0
      fi
      ;;
  esac

  # Fallback
  printf "[%s] %s\n" "$title" "$msg" >&2
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Version and help
__version() { echo "$PROG $VERSION"; }

__help() {
  cat <<EOF
$PROG $VERSION - File preview script for ranger

Usage: $PROG <file_path> <width> <height> <cache_path> <image_enabled>

Options:
  -v, --version    Show version
  -h, --help       Show this help

Exit Codes:
  0 - success, display stdout as preview
  1 - no preview
  2 - plain text, display file content
  3 - fix width (don't reload on width change)
  4 - fix height (don't reload on height change)
  5 - fix both (never reload)
  6 - image, display cached image
  7 - image, display file directly as image

This script is called by ranger when use_preview_script is enabled.
EOF
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Handle extensions
handle_extension() {
  case "${FILE_EXTENSION_LOWER}" in
    a|ace|alz|arc|arj|bz|bz2|cab|cpio|deb|gz|jar|lha|lz|lzh|lzma|lzo|rpm|rz|t7z|tar|tbz|tbz2|tgz|tlz|txz|tZ|tzo|war|xpi|xz|Z|zip)
      atool --list -- "${FILE_PATH}" && exit 5
      bsdtar --list --file "${FILE_PATH}" && exit 5
      exit 1 ;;
    rar)
      unrar lt -p- -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    7z)
      7z l -p -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    pdf)
      pdftotext -l 10 -nopgbrk -q -- "${FILE_PATH}" - | fmt -w "${PV_WIDTH}" && exit 5
      mutool draw -F txt -i -- "${FILE_PATH}" 1-10 | fmt -w "${PV_WIDTH}" && exit 5
      exiftool "${FILE_PATH}" && exit 5
      exit 1 ;;
    torrent)
      transmission-show -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    odt|ods|odp|sxw)
      odt2txt "${FILE_PATH}" && exit 5
      pandoc -s -t markdown -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    xlsx)
      xlsx2csv -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    htm|html|xhtml)
      w3m -dump "${FILE_PATH}" && exit 5
      lynx -dump -- "${FILE_PATH}" && exit 5
      elinks -dump "${FILE_PATH}" && exit 5
      pandoc -s -t markdown -- "${FILE_PATH}" && exit 5 ;;
    json)
      jq --color-output . "${FILE_PATH}" && exit 5
      python -m json.tool -- "${FILE_PATH}" && exit 5 ;;
    dff|dsf|wv|wvc)
      mediainfo "${FILE_PATH}" && exit 5
      exiftool "${FILE_PATH}" && exit 5 ;;
  esac
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Handle images
handle_image() {
  local DEFAULT_SIZE="1920x1080"
  local mimetype="${1}"

  case "${mimetype}" in
    image/*)
      local orientation
      orientation="$(identify -format '%[EXIF:Orientation]\n' -- "${FILE_PATH}" 2>/dev/null)"
      if [[ -n "$orientation" && "$orientation" != 1 ]]; then
        convert -- "${FILE_PATH}" -auto-orient "${IMAGE_CACHE_PATH}" && exit 6
      fi
      exit 7 ;;
    application/font*|application/*opentype)
      preview_png="/tmp/$(basename "${IMAGE_CACHE_PATH%.*}").png"
      if fontimage -o "${preview_png}" \
          --pixelsize "120" --fontname \
          --pixelsize "80" \
          --text "  ABCDEFGHIJKLMNOPQRSTUVWXYZ  " \
          --text "  abcdefghijklmnopqrstuvwxyz  " \
          --text "  0123456789.:,;(*!?') ff fl fi ffi ffl  " \
          --text "  The quick brown fox jumps over the lazy dog.  " \
          "${FILE_PATH}" 2>/dev/null; then
        convert -- "${preview_png}" "${IMAGE_CACHE_PATH}" && rm "${preview_png}" && exit 6
      fi
      exit 1 ;;
  esac
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Handle mime types
handle_mime() {
  local mimetype="${1}"
  case "${mimetype}" in
    text/rtf|*msword)
      catdoc -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    *wordprocessingml.document|*/epub+zip|*/x-fictionbook+xml)
      pandoc -s -t markdown -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    *ms-excel)
      xls2csv -- "${FILE_PATH}" && exit 5
      exit 1 ;;
    text/*|*/xml)
      if [[ "$(stat --printf='%s' -- "${FILE_PATH}" 2>/dev/null || stat -f%z -- "${FILE_PATH}" 2>/dev/null)" -gt "${HIGHLIGHT_SIZE_MAX}" ]]; then
        exit 2
      fi
      if [[ "$(tput colors 2>/dev/null)" -ge 256 ]]; then
        local pygmentize_format='terminal256'
        local highlight_format='xterm256'
      else
        local pygmentize_format='terminal'
        local highlight_format='ansi'
      fi
      env HIGHLIGHT_OPTIONS="${HIGHLIGHT_OPTIONS}" highlight --out-format="${highlight_format}" --force -- "${FILE_PATH}" && exit 5
      env COLORTERM=8bit bat --color=always --style="plain" -- "${FILE_PATH}" && exit 5
      pygmentize -f "${pygmentize_format}" -O "style=${PYGMENTIZE_STYLE}" -- "${FILE_PATH}" && exit 5
      exit 2 ;;
    image/vnd.djvu)
      djvutxt "${FILE_PATH}" | fmt -w "${PV_WIDTH}" && exit 5
      exiftool "${FILE_PATH}" && exit 5
      exit 1 ;;
    image/*)
      exiftool "${FILE_PATH}" && exit 5
      exit 1 ;;
    video/*|audio/*)
      mediainfo "${FILE_PATH}" && exit 5
      exiftool "${FILE_PATH}" && exit 5
      exit 1 ;;
  esac
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Handle fallback
handle_fallback() {
  echo '----- File Type Classification -----' && file --dereference --brief -- "${FILE_PATH}" && exit 5
  exit 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main function
main() {
  # Parse options
  case "${1:-}" in
    -v|--version) __version; exit 0 ;;
    -h|--help) __help; exit 0 ;;
  esac

  # Set strict options for previewing
  set -o noclobber -o noglob -o nounset -o pipefail
  IFS=$'\n'

  # Script arguments
  FILE_PATH="${1}"
  PV_WIDTH="${2}"
  PV_HEIGHT="${3}"
  IMAGE_CACHE_PATH="${4}"
  PV_IMAGE_ENABLED="${5}"

  FILE_EXTENSION="${FILE_PATH##*.}"
  FILE_EXTENSION_LOWER="$(printf "%s" "${FILE_EXTENSION}" | tr '[:upper:]' '[:lower:]')"

  # Settings
  HIGHLIGHT_SIZE_MAX=262143
  HIGHLIGHT_TABWIDTH=${HIGHLIGHT_TABWIDTH:-8}
  HIGHLIGHT_STYLE=${HIGHLIGHT_STYLE:-pablo}
  HIGHLIGHT_OPTIONS="--replace-tabs=${HIGHLIGHT_TABWIDTH} --style=${HIGHLIGHT_STYLE} ${HIGHLIGHT_OPTIONS:-}"
  PYGMENTIZE_STYLE=${PYGMENTIZE_STYLE:-autumn}
  OPENSCAD_IMGSIZE=${RNGR_OPENSCAD_IMGSIZE:-1000,1000}
  OPENSCAD_COLORSCHEME=${RNGR_OPENSCAD_COLORSCHEME:-Tomorrow Night}

  # Handle image preview if enabled
  MIMETYPE="$(file --dereference --brief --mime-type -- "${FILE_PATH}" 2>/dev/null)"
  if [[ "${PV_IMAGE_ENABLED}" == 'True' ]]; then
    handle_image "${MIMETYPE}"
  fi

  # Process file
  handle_extension
  handle_mime "${MIMETYPE}"
  handle_fallback
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Execute
main "$@"
exit $?
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
